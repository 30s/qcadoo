<?xml version="1.0" encoding="UTF-8"?>

<view xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schema.qcadoo.org/view" 
	xsi:schemaLocation="http://schema.qcadoo.org/view http://schema.qcadoo.org/view.xsd"
	name="pluginsList"
	modelPlugin="qcadooPlugin"
	modelName="plugin"
	menuAccessible="true"
	defaultAuthorizationRole="ROLE_ADMIN">
	
	<component type="window" name="window" reference="window">
		<ribbon>
			<group name="plugins">
				<bigButton name="downloadPlugin" icon="downloadIcon24.png"
					action="#{grid}.fireEvent(downloadPlugin);" message="plugins.ribbon.messages.download" />
			</group>
			<group name="actions">
				<bigButton name="changeStatus" icon="enableIcon24.png"
					state="disabled">
					<script>
						<![CDATA[
							this.element.width(100);
							this.removeOnChangeListeners();
							this.addOnChangeListener({
								onClick: function() {
									if (this.state == "enable") {
										if (window.confirm("#{translate(plugins.ribbon.confirms.enable)}")) {
											#{grid}.performEvent('enablePlugin', []);
										};
									} else if (this.state == "disable") {
										if (window.confirm("#{translate(plugins.ribbon.confirms.disable)}")) {
											#{grid}.performEvent('disablePlugin', []);
										};
									}
								}
							});
						]]>
					</script>
				</bigButton>
				<smallButton name="remove" icon="deleteIcon16.png"
					state="disabled">
					<script>
						<![CDATA[
							this.removeOnChangeListeners();
							this.addOnChangeListener({
								onClick: function() {
									if (window.confirm("#{translate(plugins.ribbon.confirms.remove)}")) {
										#{grid}.performEvent('removePlugin', []);
									}
								}
							});
						]]>
					</script>
				</smallButton>
			</group>
		</ribbon>
		<component type="grid" name="plugins" reference="grid">
			<option type="column" name="name" fields="name" link="true"
				width="100" />
			<option type="column" name="identifier" fields="identifier"
				link="true" width="80" />
			<option type="column" name="vendor" fields="vendor" width="100" />
			<option type="column" name="version" fields="version" width="40" />
			<option type="column" name="state" fields="state" width="60" />
			<option type="column" name="isSystem" fields="isSystem" width="60" />
			<option type="order" column="identifier" direction="asc" />
			<option type="correspondingView" value="plugins/pluginDetails" />
			<option type="correspondingComponent" value="form" />
			<option type="correspondingViewInModal" value="true" />
			<option type="searchable" value="identifier,version,state,isSystem" />
			<option type="orderable" value="identifier,version,state,isSystem" />
			<option type="paginable" value="false" />
			<option type="deletable" value="false" />
			<option type="creatable" value="false" />
			<option type="fullscreen" value="true" />
			<option type="multiselect" value="true" />
			<listener event="downloadPlugin"
				bean="com.qcadoo.mes.plugins.controller.PluginManagmentViewHook"
				method="onDownloadButtonClick" />
			<listener event="enablePlugin"
				bean="com.qcadoo.mes.plugins.controller.PluginManagmentViewHook"
				method="onEnableButtonClick" />
			<listener event="disablePlugin"
				bean="com.qcadoo.mes.plugins.controller.PluginManagmentViewHook"
				method="onDisableButtonClick" />
			<listener event="removePlugin"
				bean="com.qcadoo.mes.plugins.controller.PluginManagmentViewHook"
				method="onRemoveButtonClick" />
			<script>
				<![CDATA[
					var downloadRibbonItem = #{window}.getRibbonItem("plugins.download");
					var changeStatusRibbonItem = #{window}.getRibbonItem("actions.changeStatus");
					var removeRibbonItem = #{window}.getRibbonItem("actions.remove");
					this.removeOnChangeListeners();
					this.addOnChangeListener({
						onChange: function(selectedEntitiesArray) {
							if (selectedEntitiesArray.length == 0) {
								changeStatusRibbonItem.disable();
								removeRibbonItem.disable();
							} else {
								var anySystem = false;
								var allEnabled = true;
								var noneEnabled = true;
								for (var i in selectedEntitiesArray) {
									if (selectedEntitiesArray[i].fields.isSystem == "1") {
										anySystem = true;
										break;
									}
									var state = selectedEntitiesArray[i].fields.state;
									if (state == 'ENABLED') {
										noneEnabled = false;
									} else {
										allEnabled = false;
									}
									
								}
								if (anySystem) {
									changeStatusRibbonItem.disable("#{translate(plugins.ribbon.messages.base)}");
									removeRibbonItem.disable("#{translate(plugins.ribbon.messages.base)}");
								} else {
									removeRibbonItem.enable("#{translate(plugins.ribbon.messages.remove)}");
									if (allEnabled) {
										changeStatusRibbonItem.enable();
										changeStatusRibbonItem.state = "disable";
										changeStatusRibbonItem.setLabel("#{translate(plugins.pluginsList.window.ribbon.actions.disable)}");
										changeStatusRibbonItem.setIcon('disableIcon24.png');
									} else if (noneEnabled) {
										changeStatusRibbonItem.enable();
										changeStatusRibbonItem.state = "enable";
										changeStatusRibbonItem.setLabel("#{translate(plugins.pluginsList.window.ribbon.actions.changeStatus)}");
										changeStatusRibbonItem.setIcon('enableIcon24.png');
									} else {
										changeStatusRibbonItem.disable("#{translate(plugins.ribbon.messages.mixedStatus)}");
									}
								}
							}
						}
					});
				]]>
			</script>
		</component>
		<option type="fixedHeight" value="true" />
		<option type="header" value="false" />
		<script>
			<![CDATA[
				this.addOnChangeListener({
					onSetValue: function(selectedEntitiesArray) {
						this.updateMenu();
					}
				});
			]]>
		</script>
	</component>
</view>